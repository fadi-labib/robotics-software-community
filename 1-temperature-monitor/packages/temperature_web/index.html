<!DOCTYPE html>
<html>
   
<head>
    <meta charset="UTF-8">
    <title>ROS2 Temperature Monitor</title>
    <!-- import the roslib.js library (a JavaScript API, which communicates with rosbridge over Websockets)-->
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <!-- import chart.js for making the line chart-->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- css file -->
    <link rel="stylesheet" href="style.css">

</head>

<body>

    <body>
        <div class="container">
            <h1>Temperature Monitor</h1>
            <p class="status-line">
                Rosbridge Status: <span id="status" class="status">N/A</span>
            </p>
            <p class="max-temp-line"> 
                Max Temperature: <span id="maxTemp">N/A</span>
            </p>
            <canvas id="temperatureChart"></canvas>
        </div>

        <script>
            
            // Connect to rosbridge
            const ros = new ROSLIB.Ros({ url: "ws://localhost:9090" });

            // Update status of rosbridge
            ros.on("connection", () => {
                document.getElementById("status").textContent = "Connected";
                document.getElementById("status").className = "status connected";
            });

            ros.on("error", (error) => {
                document.getElementById("status").innerHTML = `errored out (${error})`;
                document.getElementById("status").className = "status error";
            });

            ros.on("close", () => {
                document.getElementById("status").textContent = "Disconnected";
                document.getElementById("status").className = "status";;
            });

            // Create a topic object '/temperature'
            const tempListener = new ROSLIB.Topic({
                ros,
                name: "/temperature",
                messageType: "temperature_interfaces/msg/Temperature",
            });

            // Create a topic object '/processed_temps'
            const processed_tempsListener = new ROSLIB.Topic({
                ros,
                name: "/processed_temps",
                messageType: "std_msgs/msg/Float64MultiArray",
            });

            // Creating the Chart.js line chart
            
            // intialze defualt values for warning range 
            warning_max = 50.0;
            warning_min = 10.0;

            const ctx = document.getElementById("temperatureChart").getContext("2d");
            const tempChart = new Chart(ctx, {
                type: "line",
                data: {
                    labels: [], 
                    datasets: [
                        {
                            label: "Temperature (째C)",
                            data: [],
                            borderColor: "blue",
                            pointBackgroundColor:[],
                            fill: false,
                            tension: 0.4,

                        },
                        {
                            label: "Moving Average (째C)",
                            data: [],
                            borderColor: "green",
                            backgroundColor: "green",
                            fill: false,
                            tension: 0.4,
                            hidden: true 
                        }
                    ],
                },
                options: {
                    responsive: true,
                    animation: false,
                    scales: {
                        x: { title: { display: true, text: "Time" } },
                        y: { title: { display: true, text: "Temperature (째C)" } },
                    },
                },
            });
            
            // Subscribe to '/temperature'
            tempListener.subscribe((temperature_message) => {
                console.log("Received message from /temperature:", temperature_message);

                const tempValue = temperature_message.value
                const timestamp = new Date().toLocaleTimeString();

                // Add new data to chart whenever a ROS message arrives
                tempChart.data.labels.push(timestamp);
                tempChart.data.datasets[0].data.push(tempValue);

                // Determine color for new point
                // this also updates colors for all points in case warning range changed
                tempChart.data.datasets[0].pointBackgroundColor = tempChart.data.datasets[0].data.map(value => {
                    if (value > warning_max || value < warning_min) {
                        return "red";
                    } else {
                        return "blue";
                    }
                });

                tempChart.update();
            });

            // Subscribe to '/processed_temps' 
            processed_tempsListener.subscribe((processed_temps_message) => {
                console.log("Received message from /processed_temps:", processed_temps_message);

                const mv_average = processed_temps_message.data[0]
                const timestamp = new Date().toLocaleTimeString();
                // Only add moving average to chart if it's not 0.00 (not the defualt value)
                if (mv_average !== 0.00) {
                    tempChart.data.datasets[1].hidden = false;
                    tempChart.data.datasets[1].data.push(mv_average);
                }         
                // Update Max Temperature
                const max_temp = processed_temps_message.data[1]
                document.getElementById("maxTemp").textContent = parseFloat(max_temp).toFixed(2) + "째C";
                
                // Get warning max & min 
                warning_max= processed_temps_message.data[2];
                warning_min = processed_temps_message.data[3];

                tempChart.update();
            });   
        </script>
    </body>

</html>